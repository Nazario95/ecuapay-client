import{obtenerDoc,consulta}from"./fbmanifeswebpack.js";import{forceLogout}from"./sesion.js";let cardId,cardDetails,onlyTrx=!1,cardDisabled=!1;document.addEventListener("DOMContentLoaded",(()=>{listenerBtnCardInfo()}));let urlId=new URLSearchParams(location.search);async function getCardData(){let e=await obtenerDoc("cards",cardId);console.log(),null==e.data()&&errorSesion(),0==e.data().status&&(cardDisabled=!0),cardDisabled?cardDisabled&&(console.log(),document.querySelector(".card-active-time").textContent="Tarjeta Desactivada",document.querySelector(".no-item-found").innerHTML='\n            <h3 class="fs-5 pt-3 text-light">Esta tarrjeta ha sida desactivada</h3>\n            <p>Contacte con el administrador al +240 555 712 824 para mas informacion.</p>\n            <p>Haz clic en el icono de whatsapp que esta mas abajo</p>\n        ',noDataMgs()):0==onlyTrx?e.data()?(erasePlaceHolder(),insertCardDataDOM(e.data())):e.data()||noDataMgs():1==onlyTrx&&loadAllTrx()}function erasePlaceHolder(){document.querySelectorAll(".inputstyle").forEach((e=>{e.classList.remove("d-none")}))}function insertCardDataDOM(e){let{totalSalde:a,cardType:n,cardNumber:s,cardHolderName:t,cardCcv:i,cardExpDate:r,activeTime:o,idAddress:l,clientId:d}=e;document.querySelector(".card-active-time").textContent=o,document.querySelector("#salde").value=`${a}$`,"mc"==n?(document.querySelector(".logo-card-mc").classList.remove("d-none"),document.querySelector(".card-logo-load-efx").classList.add("d-none")):"visa"==n&&(document.querySelector(".logo-card-visa").classList.remove("d-none"),document.querySelector(".card-logo-load-efx").classList.add("d-none")),document.querySelector("#cardName").value=t,document.querySelector("#cardNumber").value=s,document.querySelector("#salde").value=`${formatNumbWithPoint(a)}$`,document.querySelector("#expiry").value=r,document.querySelector("#cvv").value=i,cardDetails={idClient:d,client:t,address:l},loadAllTrx()}async function loadAllTrx(){let e,a=await consulta({cardId:cardId},"transactions-history"),n="",s=[],t=[];if(a.forEach((e=>{s.push(Number(e.data().numbTx)),t.push(e.data())})),e=orderNumbs(s),e.length>0)for(let a=e.length-1;a>=0;a--)t.forEach((s=>{e[a]==s.numbTx&&(n+=getAccordionItem(s,a))}));e.length>10&&!onlyTrx&&(document.querySelector("#my-trx").setAttribute("href",`./trx/?trx_card=${cardId}`),document.querySelector("#my-trx").classList.remove("disabled","d-none")),document.querySelector(".container-acordion-items").innerHTML=n}function formatNumbWithPoint(e,a="es-ES"){const n=Number(e);if(isNaN(n))return console.warn(`"${e}" no es un número válido y no puede ser formateado.`),"";try{return new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:20}).format(n)}catch(e){return console.error(`Error al formatear el número con el locale "${a}":`,e),n.toString()}}function getAccordionItem(e,a){let{timeTransaction:n,statusPayment:s,storeName:t,totalPaid:i,numbTx:r,idTX:o}=e;return`\n            <div class="accordion-item">\n                            <h2 class="accordion-header" id="heading-${a}">                    \n                                <button class="accordion-button text-light bg-color" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${a}" aria-expanded="true" aria-controls="collapseOne">                      \n\n                                    \x3c!-- sin transaction --\x3e\n                                    <div class="d-none">\n                                        <h3 class="fs-5 pt-3 text-light">No has realizado ningun pago todavia</h3>\n                                        <p>\n                                            <small>\n                                                Todos los pagos que realices con tu tarjeta, o con cualquier metodo de pago alternativo al que asocies tu tarjeta, apareceran aqui\n                                            </small>\n                                        </p>\n                                    </div>\n\n                                    \x3c!-- Header-Titulo de previsializacion --\x3e\n                                    <div class="">  \n                                        <span>Trx Nº: ${r}</span>                                      \n                                        <span class="text-${"1"==s?"success":"danger"} ms-2 p-1">${"1"==s?"Completado":"Pendiente"}</span> \n                                    </div>\n\n                                </button>\n                            </h2>\n\n                            \x3c!-- datos inyectables de la db --\x3e\n                            <div id="collapse-${a}" class="accordion-collapse collapse" aria-labelledby="heading-${a}" data-bs-parent="#accordionExample">\n                \n                                <div class="accordion-body">\n\n                                    \x3c!-- id transaction --\x3e\n                                    <small class="text-warning">Id de Transaccion</small>\n                                    <p class="text-light">\n                                    ${o}\n                                    </p>\n\n                                    <span class="text-warning">${n.split("T")[0]} | ${n.split("T")[1]} </span>\n\n                                    <div class="d-flex justify-content-around gap-5 mt-3">\n                                        <p>${t} - Pago ${"1"==s?"Completado":"Pendiente"} </p>\n                                        <p class="text-danger fw-bold">- ${formatNumbWithPoint(i)} $ </p>\n                                    </div> \n\n                                    \x3c!-- Note: --\x3e\n                                    <small class="text-warning">Nota:</small><br>\n                                    <p class="text-light">\n                                        \x3c!-- good --\x3e\n                                        ${1==s?` Su pago de -${formatNumbWithPoint(i)} $ se ha realizado correctamente en la plataforma ${t}.`:""}\n                                       \n                                    </p>\n                                    <p class="text-danger">\n                                        \x3c!-- pending --\x3e\n                                        ${2==s?"Debido a retrasos bancarios temporales, su saldo podria tardar unos minutos, o a veces horas, en actualizarse. Vuelva pronto.":""}\n                                    </p>\n                                </div>\n                            </div>\n                </div>\n        `}function orderNumbs(e){return[...e].sort(((e,a)=>e-a))}function noDataMgs(){document.querySelector(".card-logo-load-efx").classList.add("d-none"),document.querySelector(".no-item-found").classList.remove("d-none")}async function listenerBtnCardInfo(){document.querySelectorAll(".card-info-btn").forEach((e=>{e.addEventListener("click",(()=>{if("btn-card-details"==e.classList[0])modalCardData();else if("btn-how-use"==e.classList[0])document.querySelector(".txt-titile-card-info").textContent="COMO USAR LA TARJETA",document.querySelector(".card-detail-data").innerHTML='\n                    <div class="mb-5">\n                        <span class="text-light fw-bold fs-6">\n                            Verifique que su Mastercard funcione ingresando su número de tarjeta, fecha de vencimiento, código CVV y dirección de facturación. Use la direccion que se le indica en la seccion de "Detalles de la tarjeta"\n                        </span>\n                    </div>\n                ';else if("btn-term-condition"==e.classList[0])document.querySelector(".txt-titile-card-info").textContent="TÉRMINOS Y CONDICIONES DE LA TARJETA VIRTUAL",document.querySelector(".card-detail-data").innerHTML='\n                    <div  class="mb-2">\n                        <h3 class="text-light">Preámbulo</h3>\n                        <span class="text-light fw-bold fs-6">\n                            Estos Términos y Condiciones (en adelante denominados "Términos") son legalmente vinculantes y rigen la relación entre usted (el "Titular de la tarjeta" o "usted") y EcuaPay, un servicio de emision de tarjetas de prepago con sede en la Republica de Guinea Ecuatorial(en adelante denominada "Ecuapay", "nosotros", "nos" o "nuestro"), con respecto a su participación y uso de cualquier Programa de Tarjeta Virtual (el "Programa").\n                        </span>\n                    </div>\n\n                    <div  class="mb-2">\n                        <h3 class="text-light">1. Descripción general del programa</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            El Programa proporciona a los participantes elegibles tarjetas de pago virtuales (la "Tarjeta") para realizar transacciones en línea. Estas Tarjetas son emitidas por bancos asociados, sujetas a estos Términos y a cualquier término adicional establecido por los bancos emisores. Las tarjetas pueden emitirse mediante diversas plataformas de pago, incluyendo, entre otras, Visa o Mastercard.\n                        </span>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">2. Requisitos de elegibilidad y KYC</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Para participar en el Programa, debe tener al menos 18 años y residir en una jurisdicción donde el Programa esté disponible. Los diferentes programas de tarjetas pueden tener distintos requisitos de Conozca a su Cliente (KYC):\n\n                            KYC simplificado: algunos programas de tarjetas pueden ofrecer una funcionalidad básica con verificación simplificada hasta ciertos límites de transacciones y saldos.\n\n                            KYC completo: ciertos programas de tarjetas o límites de transacción más altos pueden requerir una verificación de identidad completa y documentación adicional.\n\n                            Debida diligencia mejorada: algunas jurisdicciones o patrones de uso pueden requerir pasos de verificación adicionales\n\n                            EcuaPay se reserva el derecho de verificar su elegibilidad en cualquier momento y de rechazar su participación a su discreción. Los requisitos específicos de KYC para cada programa se comunicarán claramente durante el proceso de solicitud.\n                        </span>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">3. Emisión y activación de la tarjeta</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Las tarjetas son emitidas por los servicios webs asociados con EcuaPay, estos servicios cuentan con licencia para emitir tarjetas de prepago en como servicios a terceros.\n\n                            Tras su emisión, las Tarjetas se activan por un periodo determinado. Los titulares pueden extender este periodo de activación según las condiciones especificadas en el sitio web.\n                        </span>\n                    </div>\n\n                     <div class="mb-2">\n                        <h3 class="text-light">4. Caducidad de la tarjeta y pérdida del saldo</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Todas las tarjetas virtuales emitidas bajo el programa tienen una validez máxima de 12 meses a partir de su fecha de emisión, salvo que se especifique lo contrario. Transcurrido este período, la tarjeta caducará automáticamente y quedará inactiva. El saldo restante de la tarjeta caducada se deducirá y ya no se podrá acceder a él. Los titulares de la tarjeta son responsables de controlar la fecha de vencimiento y de utilizar los fondos antes de su vencimiento.\n                        </span>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">5. Límites de carga y transacciones de tarjetas</h3>\n\n                        <div class="mb-2">\n                            <p class="text-decoration-underline fs-4">\n                                5.1. Límites de carga\n                            </p>\n                            <ul>                           \n                                <li class="text-light">Algunas tarjetas pueden ser recargables, sujetas a términos específicos del programa.</li>\n\n                                <li class="text-light">Pueden aplicarse límites de carga diarios, semanales, mensuales y anuales.</li>\n\n                                <li class="text-light">Los límites de carga pueden variar según el nivel KYC y el programa de la tarjeta.</li>\n\n                                <li class="text-light">Todos los límites aplicables se mostrarán en el sitio web durante las transacciones relevantes.</li>\n                            </ul>\n                        </div>\n\n                          <div class="mb-2">\n                            <p class="text-decoration-underline fs-4">\n                                5.2. Límites de transacciones\n                            </p>\n                            <ul>                           \n                                <li class="text-light">Se aplican montos mínimos y máximos de transacción.</li>\n\n                                <li class="text-light">Los límites pueden variar según el programa de la tarjeta y el nivel KYC.</li>\n\n                                <li class="text-light">Múltiples transacciones rechazadas pueden resultar en la suspensión temporal de la tarjeta.</li>\n\n                                <li class="text-light">Después de 10 transacciones rechazadas consecutivas, su tarjeta puede ser congelada o suspendida por el banco emisor debido a requisitos regulatorios.</li>\n                            </ul>\n                        </div>                        \n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">6. Restricciones de uso de la tarjeta</h3>\n                       <ul>                           \n                                <li class="text-light">Las tarjetas no deben utilizarse para transacciones que excedan el saldo cargado..</li>\n\n                                <li class="text-light">Se prohíbe el uso de Tarjetas en países designados por el Grupo de Acción Financiera Internacional (GAFI) como no cooperativos en la lucha contra el blanqueo de capitales y la financiación del terrorismo.</li>\n\n                                <li class="text-light">Múltiples transacciones rechazadas pueden resultar en la suspensión temporal de la tarjeta.</li>\n                            </ul>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">7. Suspensión de cuenta y tarjeta</h3>\n                        <span> En caso de:</span>\n                        <ul>                           \n                                <li class="text-light">Un incumplimiento de estos Términos</li>\n\n                                <li class="text-light">Actividades fraudulentas.</li>\n\n                                <li class="text-light">Exceso de transacciones rechazadas.</li>\n                                <li class="text-light">Requisitos reglamentarios.</li>\n                                <li class="text-light">Solicitud de nuestros proveedores asociados.</li>\n                        </ul>\n\n                        <p>Cenitward se reserva el derecho de suspender su cuenta y cualquier Tarjeta asociada. La notificación de dicha suspensión se le enviará por correo electrónico.</p>\n                    </div>\n\n                    div class="mb-2">\n                        <h3 class="text-light">8. Tarifas y cargos</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Todas las tarifas y cargos aplicables se muestran claramente en el sitio web en cada paso del proceso de compra. Estas tarifas pueden incluir, entre otras, tarifas de activación, recarga y generación de tarjetas. Consulte el sitio web para obtener información actualizada sobre las tarifas.\n                        </span>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">9. Modificación de los Términos</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            EcuaPay se reserva el derecho de modificar estos Términos en cualquier momento sin previo aviso. Dichas modificaciones entrarán en vigor inmediatamente después de su publicación en nuestro sitio web o de recibir la notificación correspondiente.\n                        </span>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">10. Ley aplicable y resolución de disputas</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Estos Términos se regirán e interpretarán de conformidad con las leyes de la Republica de Guinea Ecuatorial.\n                        </span>\n                    </div>\n\n                    <div class="mb-2">\n                        <h3 class="text-light">11. Limitación de responsabilidad</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Cenitward y sus bancos asociados no serán responsables de las pérdidas incurridas debido al uso no autorizado de la Tarjeta, siempre que el Titular de la Tarjeta haya tomado medidas razonables para proteger los detalles de la Tarjeta.\n                        </span>\n                    </div>\n\n                     <div class="mb-2">\n                        <h3 class="text-light">12. Condiciones Generales de la Tarjeta</h3>\n                                                  \n                            <ul>                           \n                                <li class="text-light">El saldo de cualquier tarjeta no es reembolsable.</li>\n\n                                <li class="text-light">Todas las tarjetas están sujetas a los términos y condiciones de sus respectivos proveedores y redes de pago de su pais y globales.</li>\n                                <li class="text-light">Los sistemas de monitoreo de transacciones pueden marcar automáticamente y suspender temporalmente las tarjetas según patrones de actividad sospechosos.</li>\n                            </ul>\n                      \n                    </div>\n\n                     <div class="mb-2">\n                        <h3 class="text-light">RECONOCIMIENTO</h3>\n                        <span class="text-light fw-bold fs-6">                            \n                            Al participar en el Programa, usted reconoce haber leído, comprendido y aceptado estos Términos. Si no los acepta, no debe usar ni acceder al Programa.\n                        </span>\n                    </div>\n\n                    \n                ';else if("btn-logout"==e.classList[0]){confirm("Cerrar sesion y salir?")&&forceLogout()}}))}))}async function modalCardData(){let e=document.querySelector(".card-detail-data");document.querySelector(".txt-titile-card-info").innerHTML="",e.innerHTML="",document.querySelector(".txt-titile-card-info").textContent="DIRECCION DE FACTURACION PREDETERMINADA DE LA TARJETA";const{address:a,idClient:n}=cardDetails;let s=await obtenerDoc("addresses",a),t=await obtenerDoc("clients",n);const{phoneNumber:i,name:r,surname:o}=t.data(),{addrsCity:l,addrsCountry:d,addrsDirection:c,addrsPostaCode:u}=s.data();e.innerHTML=`        \n        <div class="form w-100 mb-2">\n            <label>Cliente</label>              \n            <input class="input" type="text" value="${r} ${o}" disabled>\n            <span class="input-border"></span>               \n        </div>\n\n        <div class="form w-100 mb-2">\n            <label>Direccion</label>              \n            <input class="input" type="text" value="${c}" disabled>\n            <span class="input-border"></span>               \n        </div>\n\n        <div class="form w-100 mb-2">\n            <label>Codigo Postal</label>              \n            <input class="input" type="text" value="${u}" disabled>\n            <span class="input-border"></span>               \n        </div>\n\n        <div class="form w-100 mb-2">\n            <label>Ciudad</label>              \n            <input class="input" type="text" value="${l}" disabled>\n            <span class="input-border"></span>               \n        </div>\n\n        <div class="form w-100 mb-2">\n            <label>Pais</label>              \n            <input class="input" type="text" value="${d}" disabled>\n            <span class="input-border"></span>               \n        </div>\n\n        <div class="form w-100 mb-4">\n            <label>Telefono</label>              \n            <input class="input" type="text" value="${i}" disabled>\n            <span class="input-border"></span>               \n        </div>\n\n    `}urlId.size>0?urlId.forEach(((e,a)=>{"card"==a?(cardId=e,getCardData()):"trx_card"==a&&(document.querySelector(".btn-inicio").setAttribute("href",`../?card=${e}`),onlyTrx=!0,cardId=e,getCardData())})):urlId.size<=0&&(alert("Error de sesion"),forceLogout());