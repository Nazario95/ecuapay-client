import {obtenerDoc,consulta} from "./fbmanifeswebpack.min.js";import {forceLogout} from "./sesion.min.js";let cardId;let onlyTrx=!1;let cardDisabled=!1;let urlId=new URLSearchParams(location.search);if(urlId.size>0){urlId.forEach((v,k)=>{if(k=='card'){cardId=v;getCardData()}else if(k=='trx_card'){document.querySelector('.btn-inicio').setAttribute('href',`../?card=${v}`);onlyTrx=!0;cardId=v;getCardData()}})}else{alert('Error de sesion');forceLogout()}async function getCardData(){let resCardData=await obtenerDoc('cards',cardId);resCardData.data()==undefined?errorSesion():'';resCardData.data().status==!1?cardDisabled=!0:'';if(!cardDisabled){if(onlyTrx==!1){if(resCardData.data()){erasePlaceHolder();insertCardDataDOM(resCardData.data())}else{noDataMgs()}}else{loadAllTrx()}}else{console.log('tarjeta Desactivada');document.querySelector('.card-active-time').textContent='Tarjeta Desactivada';document.querySelector('.no-item-found').innerHTML=`<h3 class="fs-5 pt-3 text-light">Esta tarrjeta ha sida desactivada</h3><p>Contacte con el administrador al +240 555 712 824 para mas informacion.</p><p>Haz clic en el icono de whatsapp que esta mas abajo</p>`;noDataMgs()}}function erasePlaceHolder(){document.querySelectorAll('.inputstyle').forEach(e=>{e.classList.remove('d-none')})}function insertCardDataDOM(d){let{totalSalde,cardType,cardNumber,cardHolderName,cardCcv,cardExpDate,activeTime}=d;document.querySelector('.card-active-time').textContent=activeTime;document.querySelector('#salde').value=`${totalSalde},0 XAF`;if(cardType=='mc'){document.querySelector('.logo-card-mc').classList.remove('d-none');document.querySelector('.card-logo-load-efx').classList.add('d-none')}else if(cardType=='visa'){document.querySelector('.logo-card-visa').classList.remove('d-none');document.querySelector('.card-logo-load-efx').classList.add('d-none')};document.querySelector('#cardName').value=cardHolderName;document.querySelector('#cardNumber').value=cardNumber;document.querySelector('#salde').value=`${formatNumbWithPoint(totalSalde)}.0 XAF`;document.querySelector('#expiry').value=cardExpDate;document.querySelector('#cvv').value=cardCcv;loadAllTrx()}async function loadAllTrx(){let resGetAllTrx=await consulta({cardId:cardId},'transactions-history');let accordionComp='';let trxNums=[];let trxNumsOrder;let trxDatas=[];resGetAllTrx.forEach(t=>{trxNums.push(Number(t.data().numbTx));trxDatas.push(t.data())});trxNumsOrder=orderNumbs(trxNums);if(trxNumsOrder.length>0){for(let i=trxNumsOrder.length-1;i>=0;i--){trxDatas.forEach(d=>{if(trxNumsOrder[i]==d.numbTx){accordionComp+=getAccordionItem(d,i)}})}}if(trxNumsOrder.length>10&&!onlyTrx){document.querySelector('#my-trx').setAttribute('href',`./trx/?trx_card=${cardId}`);document.querySelector('#my-trx').classList.remove('disabled','d-none')}document.querySelector('.container-acordion-items').innerHTML=accordionComp}function formatNumbWithPoint(n,l='es-ES'){const num=Number(n);if(isNaN(num)){console.warn(`"${n}" no es un número válido y no puede ser formateado.`);return''}try{return new Intl.NumberFormat(l,{minimumFractionDigits:0,maximumFractionDigits:20}).format(num)}catch(err){console.error(`Error al formatear el número con el locale "${l}":`,err);return num.toString()}}function getAccordionItem(i,idx){let{timeTransaction,statusPayment,storeName,totalPaid,numbTx,idTX}=i;let accordion=`<div class="accordion-item"><h2 class="accordion-header" id="heading-${idx}"><button class="accordion-button text-light bg-color" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${idx}" aria-expanded="true" aria-controls="collapseOne"><div class="d-none"><h3 class="fs-5 pt-3 text-light">No has realizado ningun pago todavia</h3><p><small>Todos los pagos que realices con tu tarjeta, o con cualquier metodo de pago alternativo al que asocies tu tarjeta, apareceran aqui</small></p></div><div class=""><span>Trx Nº: ${numbTx}</span><span class="text-${statusPayment=="1"?"success":"danger"} ms-2 p-1">${statusPayment=="1"?"Completado":"Pendiente"}</span></div></button></h2><div id="collapse-${idx}" class="accordion-collapse collapse" aria-labelledby="heading-${idx}" data-bs-parent="#accordionExample"><div class="accordion-body"><small class="text-warning">Id de Transaccion</small><p class="text-light">${idTX}</p><span class="text-warning">${timeTransaction.split('T')[0]} | ${timeTransaction.split('T')[1]} </span><div class="d-flex justify-content-around gap-5 mt-3"><p>${storeName} - Pago ${statusPayment=="1"?"Completado":"Pendiente"} </p><p class="text-danger fw-bold">- ${formatNumbWithPoint(totalPaid)} XAF </p></div> <small class="text-warning">Nota:</small><br><p class="text-light">${statusPayment==1?` Su pago de -${formatNumbWithPoint(totalPaid)} XAF se ha realizado correctamente en la plataforma ${storeName}.`:''}</p><p class="text-danger">${statusPayment==2?'Debido a retrasos bancarios temporales, su saldo podria tardar unos minutos, o a veces horas, en actualizarse. Vuelva pronto.':''}</p></div></div></div>`;return accordion}function orderNumbs(a){const c=[...a];return c.sort((a,b)=>a-b)}function noDataMgs(){document.querySelector('.card-logo-load-efx').classList.add('d-none');document.querySelector('.no-item-found').classList.remove('d-none')}
